## 前言

优化网页性能中，包含两个主要的优化方向，分别是减少 CPU 操作，减少网页 reflow、repaint。

GPU 硬件加速指的是使用 GPU 渲染，而非使用 CPU 进行渲染。

浏览器渲染过程：

- HTML 字符串解析成 DOM 树
- CSS 字符串解析成 CSS 树
- 合并 DOM 树 和 CSS 树，生成渲染树
- 根据渲染树计算各节点位置尺寸信息。生成布局树。
- 根据渲染树与布局树渲染元素。各个元素在绘制时，会放置在相应的渲染层。
- 将多个渲染图层合并，生成最终的页面图像显示出来。

图层类型：

- 渲染层（renderLayers）：在 DOM 树中每个节点都会对应一个 LayoutObject，当他们的 LayoutObject 处于相同的坐标空间时，就会形成一个 RenderLayers。不在合成层的渲染层与第一个拥有 GraphicsLayer 父层公用一个
- 合成层（compositeLayers）：渲染层合并。合成层拥有单独的 GraphicsLayer。
- 图形层（graphicsLayers）：例如位图，GPU。

GPU 的作用：

- CPU 将输出单个渲染层的位图到共享内存中，然后再作为纹理上传到 GPU 中，GPU 将多个位图进行合成。
- 结合 reflow，如果图层发生变化，则需要 CPU 重新计算输出图层上下文的位图，再交由 GPU 合成。
- 结合 repaint，如果仅仅只是重绘，只直接使用已有图层位图合成。

独立渲染层的优势：

- 具有独立的绘图上下文。CPU 根据绘图上下文生成位图。
- 该图层内的元素引发 repaint 时，只需要 GPU 生成新的位图即可。并且实测发现 transform 、opacity 动画不会触发 repaint，直接由 GPU 处理。

> 缺陷：多个渲染层将占用更多 GPU 资源。

如何生成独立渲染层：

- 元素具有样式属性：transform、perspective、filter。
- 特殊元素：video、iframe、canvas、webgl。
- 拥有 3D（WebGL） 上下文或者加速 2D 上下文的 canvas 元素。
- flash 元素。
- 对样式属性 opacity 做 CSS 动画。
- 父元素在独立渲染图层，则子元素均在该层。

> 独立图层的优势：缩小 reflow 的范围。
> 使用独立图层的建议：对于固定不变的区域，如果不期望被重绘，可以提升为独立的渲染层。例如 header 区域。但是也别过多的使用，因为直接占用 GPU 内存，会影响其性能。

当没有实质性的动画时，希望触发

```
.element {
    -webkit-transform: translateZ(0);
    -moz-transform: translateZ(0);
    -ms-transform: translateZ(0);
    -o-transform: translateZ(0);
    transform: translateZ(0);
    /**或者**/
    transform: rotateZ(360deg);
    transform: translate3d(0, 0, 0);
}
```

触发 GPU 的硬件加速。
目的：在不触发 reflow、repaint 生成合成帧。
应用：css 一些属性可以触发（transform 、opacity、filter、will-change）。

参考：

- [Web 性能优化-CSS3 硬件加速(GPU 加速)](https://juejin.cn/post/6844903903826296846)

光栅化的总结：

参考：[什么是光栅化](https://blog.csdn.net/linuxheik/article/details/53884132)

光栅化的本质是坐标变换、几何离散化。
总结：光栅化，就是将几何信息转换成一个个的栅格组成的图像的过程。

在 Unity3D 中，每一个美术模型由顶点和顶点构成的三角面来确定。将 3D 模型绘制到屏幕上时，根据每个三角面的三个顶点，将这个三角面所覆盖的每一个像素(栅格)进行填充的过程，就叫做光栅化。

其实，三维物体绘制到屏幕上的过程大多都是采用的这种光栅化方式。

像素：

- 图像由多个像素组成，
- 像素是构成图像的基本单元，在程序层面，每个像素信息包含色彩、纹理、深度信息。
- 在液晶屏上，每个像素有三个很小的发光二极管，像素信息反映在硬件上就是发光二极管的显示组合。

> 图元一般指基本图形元素。基本图形元素由点、线、面、图案构成。既任何一个图形都是由若干不同的点、线、面图案，以及相同图案循环组成的。

图像显示在屏幕的过程：

- 按照图像的长宽设定一个坐标，每个坐标点放置一个像素信息，信息内包含颜色、深度、透明。
- 将坐标内的每个像素信息转化为 RGB 数值。RGB 是 24bit，8bit 等于 1 字节，1 个字节由 8 位二进制组成。以 `400*500` 像素的图像，存储在内存中需要 `400*500*(24/8)` 字节。
- 将图像的二进制信息传输给显示设备，屏幕由若干个像素点构成，每个像素有三个发光二极管，每个二极管分别按照二进制数值显示。[255,0,0] 就是红色。

知道图像显示在屏幕上的基本流程后，接着需要了解如何快速生成图像的二进制表示结果。

- CPU 可以对每个坐标点的信息进行计算，但是按顺序计算还是没有优势。
- GPU 由成千上万个 cpu 组成。可以同时计算多个坐标点信息。
